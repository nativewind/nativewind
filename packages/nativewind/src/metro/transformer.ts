import worker, {
  JsTransformerConfig,
  JsTransformOptions,
  TransformResponse,
} from "metro-transform-worker";
import path from "path";

import {
  transform as cssInteropTransform,
  experimentsToJS,
} from "react-native-css-interop/metro/transformer";
import { CssToReactNativeRuntimeOptions } from "react-native-css-interop/metro";

interface NativeWindJsTransformerConfig extends JsTransformerConfig {
  transformerPath?: string;
  nativewind: {
    input: string;
    fastRefreshPort: string;
    rawOutput: string;
    parsedOutput: string;
    experiments?: CssToReactNativeRuntimeOptions["experiments"];
  };
}

export async function transform(
  config: NativeWindJsTransformerConfig,
  projectRoot: string,
  filename: string,
  data: Buffer,
  options: JsTransformOptions,
): Promise<TransformResponse> {
  // If we are importing the .css file, make it an alias for the output generated by Tailwind CLI
  if (path.resolve(process.cwd(), filename) === config.nativewind.input) {
    if (options.platform !== "web" && options.dev && options.hot) {
      // Ignore the file in native dev mode, as it will be handled by the WebSocket server
      return worker.transform(
        config,
        projectRoot,
        filename,
        Buffer.from(
          `${experimentsToJS(
            config.nativewind.experiments,
          )}const { StyleSheet } = require("react-native-css-interop");
const url = require("react-native/Libraries/Core/Devtools/getDevServer")().url.replace(/(https?:\\/\\/.*)(:\\d*\\/)(.*)/, "$1$3")
new globalThis.WebSocket(\`\${url}:${
            config.nativewind.fastRefreshPort
          }\`).addEventListener("message", (event) => StyleSheet.registerCompiled(JSON.parse(event.data)));
StyleSheet.registerCompiled(JSON.parse('${config.nativewind.parsedOutput}'));`,
          "utf8",
        ),
        options,
      );
    } else {
      data = Buffer.from(config.nativewind.rawOutput, "utf8");
    }
  }

  // Otherwise use the cssInteropTransform. It will handle JS files and composing transformers
  return cssInteropTransform(config, projectRoot, filename, data, options);
}
